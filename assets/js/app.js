async function fetchJson(url, options = {}) {
  const response = await fetch(url, options);
  const data = await response.json();
  if (!response.ok) {
    throw new Error(data.error || 'Request failed');
  }
  return data;
}

function riskClass(label) {
  const value = String(label || '').toLowerCase();
  if (value === 'high') return 'risk-high';
  if (value === 'medium') return 'risk-medium';
  return 'risk-low';
}

function renderStudents(payload) {
  const { students, summary } = payload;

  document.getElementById('metric-students').textContent = summary.total_students;
  document.getElementById('metric-high-risk').textContent = summary.high_risk;
  document.getElementById('metric-active-alerts').textContent = summary.active_alerts;

  const riskSummary = document.getElementById('risk-summary');
  riskSummary.innerHTML = [
    `<div><strong>${summary.high_risk}</strong> students need urgent intervention.</div>`,
    `<div><strong>${summary.active_alerts}</strong> active alerts generated by AI risk engine.</div>`,
    `<div>Interventions combine tutoring, counseling, and family outreach.</div>`,
  ].join('');

  const tbody = document.getElementById('students-table');
  tbody.innerHTML = students.map((s) => `
    <tr>
      <td>${s.full_name} (Grade ${s.grade_level})</td>
      <td>${s.attendance_pct.toFixed(1)}%</td>
      <td>${s.avg_score.toFixed(1)}</td>
      <td>${s.behavior_incidents}</td>
      <td>${s.wellness_signal}</td>
      <td>
        <span class="risk-pill ${riskClass(s.risk_label)}">${s.risk_label} (${s.risk_score})</span>
      </td>
    </tr>
  `).join('');
}

function renderAlerts(payload) {
  const container = document.getElementById('alerts-list');
  if (!container) return;

  const alerts = payload.alerts;
  if (!alerts.length) {
    container.innerHTML = '<p>No active alerts.</p>';
    return;
  }

  container.innerHTML = alerts.map((a) => `
    <article class="alert-card">
      <p><strong>${a.full_name}</strong> | <span class="risk-pill ${riskClass(a.alert_level)}">${a.alert_level}</span></p>
      <p>${a.alert_message}</p>
      <p><strong>Recommended Action:</strong> ${a.recommended_action}</p>
      <p class="alert-meta">Status: ${a.status} | Created: ${a.created_at}</p>
    </article>
  `).join('');
}

function appendChatMessage(role, text) {
  const chatWindow = document.getElementById('chat-window');
  if (!chatWindow) return;

  const div = document.createElement('div');
  div.className = `chat-message ${role}`;
  div.textContent = text;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function setupChatbot() {
  const form = document.getElementById('chat-form');
  const input = document.getElementById('chat-input');
  if (!form || !input) return;

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const message = input.value.trim();
    if (!message) return;

    appendChatMessage('user', message);
    input.value = '';

    try {
      const payload = await fetchJson('api/chatbot.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message }),
      });

      appendChatMessage('bot', payload.reply);
    } catch (error) {
      appendChatMessage('bot', `Chatbot unavailable: ${error.message}`);
    }
  });
}

async function initialize() {
  try {
    const requests = [fetchJson('api/students.php')];
    if (document.getElementById('alerts-list')) {
      requests.push(fetchJson('api/alerts.php'));
    }

    const results = await Promise.all(requests);
    renderStudents(results[0]);

    if (results[1]) {
      renderAlerts(results[1]);
    }
  } catch (error) {
    const message = `Unable to load dashboard data. ${error.message}`;
    document.getElementById('risk-summary').textContent = message;
    const alerts = document.getElementById('alerts-list');
    if (alerts) alerts.innerHTML = `<p>${message}</p>`;
  }

  setupChatbot();
}

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js').catch(() => {});
  });
}

initialize();
