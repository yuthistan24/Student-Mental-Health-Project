async function fetchJson(url, options = {}) {
  const response = await fetch(url, options);
  const data = await response.json();
  if (!response.ok) {
    throw new Error(data.error || 'Request failed');
  }
  return data;
}

function riskClass(label) {
  const value = String(label || '').toLowerCase();
  if (value === 'high') return 'risk-high';
  if (value === 'medium') return 'risk-medium';
  return 'risk-low';
}

function renderStudents(payload) {
  const { students, summary } = payload;

  document.getElementById('metric-students').textContent = summary.total_students;
  document.getElementById('metric-high-risk').textContent = summary.high_risk;
  document.getElementById('metric-active-alerts').textContent = summary.active_alerts;

  const riskSummary = document.getElementById('risk-summary');
  riskSummary.innerHTML = [
    `<div><strong>${summary.high_risk}</strong> students need urgent intervention.</div>`,
    `<div><strong>${summary.active_alerts}</strong> active alerts generated by AI risk engine.</div>`,
    `<div>Interventions combine tutoring, counseling, and family outreach.</div>`,
  ].join('');

  const tbody = document.getElementById('students-table');
  tbody.innerHTML = students.map((s) => `
    <tr>
      <td>${s.full_name} (Grade ${s.grade_level})</td>
      <td>${s.attendance_pct.toFixed(1)}%</td>
      <td>${s.avg_score.toFixed(1)}</td>
      <td>${s.behavior_incidents}</td>
      <td>${s.wellness_signal}</td>
      <td>
        <span class="risk-pill ${riskClass(s.risk_label)}">${s.risk_label} (${s.risk_score})</span>
      </td>
    </tr>
  `).join('');
}

function renderAlerts(payload) {
  const container = document.getElementById('alerts-list');
  if (!container) return;

  const alerts = payload.alerts;
  if (!alerts.length) {
    container.innerHTML = '<p>No active alerts.</p>';
    return;
  }

  container.innerHTML = alerts.map((a) => `
    <article class="alert-card">
      <p><strong>${a.full_name}</strong> | <span class="risk-pill ${riskClass(a.alert_level)}">${a.alert_level}</span></p>
      <p>${a.alert_message}</p>
      <p><strong>Recommended Action:</strong> ${a.recommended_action}</p>
      <p class="alert-meta">Status: ${a.status} | Created: ${a.created_at}</p>
    </article>
  `).join('');
}

function appendChatMessage(role, text) {
  const chatWindow = document.getElementById('chat-window');
  if (!chatWindow) return;

  const div = document.createElement('div');
  div.className = `chat-message ${role}`;
  div.textContent = text;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

function createVoiceAssistant() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const synth = window.speechSynthesis;
  const micButton = document.getElementById('chat-mic');
  const voiceToggle = document.getElementById('chat-voice-toggle');
  const input = document.getElementById('chat-input');
  const status = document.getElementById('chat-voice-status');
  const state = {
    canListen: !!SpeechRecognition,
    canSpeak: !!synth,
    isListening: false,
    speakEnabled: true,
    recognition: null,
  };

  if (!micButton || !voiceToggle || !input || !status) {
    return state;
  }

  if (!state.canListen) {
    micButton.disabled = true;
    micButton.title = 'Voice input is not supported in this browser.';
  }

  if (!state.canSpeak) {
    voiceToggle.disabled = true;
    voiceToggle.title = 'Voice output is not supported in this browser.';
    state.speakEnabled = false;
  }

  if (state.canListen) {
    state.recognition = new SpeechRecognition();
    state.recognition.lang = 'en-US';
    state.recognition.continuous = false;
    state.recognition.interimResults = false;
    state.recognition.onstart = () => {
      state.isListening = true;
      micButton.classList.add('active');
      status.textContent = 'Listening...';
    };
    state.recognition.onend = () => {
      state.isListening = false;
      micButton.classList.remove('active');
      status.textContent = 'Voice ready';
    };
    state.recognition.onerror = () => {
      state.isListening = false;
      micButton.classList.remove('active');
      status.textContent = 'Voice input unavailable. Try typing.';
    };
    state.recognition.onresult = (event) => {
      const text = event.results?.[0]?.[0]?.transcript?.trim() || '';
      if (text) {
        input.value = text;
        input.focus();
      }
    };
  }

  micButton.addEventListener('click', () => {
    if (!state.recognition) return;
    if (state.isListening) {
      state.recognition.stop();
    } else {
      state.recognition.start();
    }
  });

  voiceToggle.addEventListener('click', () => {
    state.speakEnabled = !state.speakEnabled;
    voiceToggle.textContent = state.speakEnabled ? 'Voice On' : 'Voice Off';
    if (!state.speakEnabled && state.canSpeak) {
      synth.cancel();
    }
  });

  return state;
}

function speakText(voiceState, text) {
  if (!voiceState || !voiceState.canSpeak || !voiceState.speakEnabled) return;
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = 1;
  utterance.pitch = 1;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utterance);
}

function setupChatbot() {
  const form = document.getElementById('chat-form');
  const input = document.getElementById('chat-input');
  if (!form || !input) return;
  const voiceState = createVoiceAssistant();

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const message = input.value.trim();
    if (!message) return;

    appendChatMessage('user', message);
    input.value = '';

    try {
      const payload = await fetchJson('api/chatbot.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message }),
      });

      appendChatMessage('bot', payload.reply);
      speakText(voiceState, payload.reply);
    } catch (error) {
      const fallback = `Chatbot unavailable: ${error.message}`;
      appendChatMessage('bot', fallback);
      speakText(voiceState, fallback);
    }
  });
}

async function initialize() {
  try {
    const requests = [fetchJson('api/students.php')];
    if (document.getElementById('alerts-list')) {
      requests.push(fetchJson('api/alerts.php'));
    }

    const results = await Promise.all(requests);
    renderStudents(results[0]);

    if (results[1]) {
      renderAlerts(results[1]);
    }
  } catch (error) {
    const message = `Unable to load dashboard data. ${error.message}`;
    document.getElementById('risk-summary').textContent = message;
    const alerts = document.getElementById('alerts-list');
    if (alerts) alerts.innerHTML = `<p>${message}</p>`;
  }

  setupChatbot();
}

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js').catch(() => {});
  });
}

initialize();
